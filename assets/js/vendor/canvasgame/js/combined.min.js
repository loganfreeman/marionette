/**
 * HTML5 Canvas Game Boilerplate 2.1.0-18012014
 * Certain components copyright their respective authors.
 *
 * @author Isaac Sukin (http://www.isaacsukin.com/)
 * @license MIT License
 * @ignore
 */

function Timer(a,b){this.autoStart="undefined"==typeof a?!0:a,this.whileAnimating=b||!1,this.lastStartTime=0,this.lastDeltaTime=0,this.elapsedTime=0,this.running=!1,this.getDelta=function(){var a=0;if(this.running){var b=this.whileAnimating?App.physicsTimeElapsed:performance.now();a=(b-this.lastDeltaTime)/1e3,this.lastDeltaTime=b,this.elapsedTime+=a}return a},this.start=function(){this.running||(this.lastStartTime=this.lastDeltaTime=this.whileAnimating?App.physicsTimeElapsed:performance.now(),this.running=!0)},this.stop=function(){this.elapsedTime+=this.getDelta(),this.running=!1},this.getElapsedTime=function(){return this.getDelta(),this.elapsedTime},this.autoStart&&this.start()}function World(a,b){this.scale=1,this._actualXscale=1,this._actualYscale=1,this.width=a||parseInt($canvas.attr("data-worldwidth"),10)||canvas.width,this.height=b||parseInt($canvas.attr("data-worldheight"),10)||canvas.height,this.originalCanvasWidth=canvas.width,this.originalCanvasHeight=canvas.height,this.xOffset=(this.width-canvas.width)/2,this.yOffset=(this.height-canvas.height)/2,context.translate(-this.xOffset,-this.yOffset),this.resize=function(a,b){var c=(a-this.width)/2,d=(b-this.height)/2;this.xOffset+=c,this.yOffset+=d,context.translate(-c,-d),this.width=a,this.height=b,jQuery(document).trigger("resizeWorld",[c,d,this])},this.scaleResolution=function(a,b,c){$canvas.hasClass("canvas-rescaled")||($canvas.css({width:canvas.width+"px",height:canvas.height+"px"}),$canvas.addClass("canvas-rescaled")),b=b||this.xOffset+canvas.width/2,c=c||this.yOffset+canvas.height/2,canvas.width=Math.round(this.originalCanvasWidth*a),canvas.height=Math.round(this.originalCanvasHeight*a),this._actualXscale=canvas.width/this.originalCanvasWidth,this._actualYscale=canvas.height/this.originalCanvasHeight,this.xOffset=Math.round(Math.min(this.width-canvas.width,Math.max(0,b-canvas.width/2))),this.yOffset=Math.round(Math.min(this.height-canvas.height,Math.max(0,c-canvas.height/2))),context.translate(-this.xOffset,-this.yOffset),this.scale=a,isAnimating()||draw()},this.canvasToWorldPosition=function(a,b){return{x:a*this._actualXscale+this.xOffset,y:b*this._actualYscale+this.yOffset}},this.worldToCanvasPosition=function(a,b){return{x:(a-this.xOffset)/this._actualXscale,y:(b-this.yOffset)/this._actualYscale}},this.centerViewportAround=function(a,b){var c=0|Math.min(this.width-canvas.width,Math.max(0,a-canvas.width/2)),d=0|Math.min(this.height-canvas.height,Math.max(0,b-canvas.height/2)),e=this.xOffset-c,f=this.yOffset-d;this.xOffset=c,this.yOffset=d,context.translate(e,f)},this.isInView=function(a,b){return b?a.x+a.width>this.xOffset&&a.x<this.xOffset+canvas.width&&a.y+a.height>this.yOffset&&a.y<this.yOffset+canvas.height:a.x>this.xOffset&&a.x+a.width<this.xOffset+canvas.width&&a.y>this.yOffset&&a.y+a.height<this.yOffset+canvas.height},this.isInWorld=function(a,b){return b?a.x+a.width>=0&&a.x<=world.width&&a.y+a.height>=0&&a.y<=world.height:a.x>=0&&a.x+a.width<=world.width&&a.y>=0&&a.y+a.height<=world.height}}function Layer(a){a=a||{},this.canvas=a.canvas||document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.context.__layer=this,this.width=a.width||(a.canvas?a.canvas.width:0)||("canvas"==a.relative?canvas.width:world.width),this.height=a.height||(a.canvas?a.canvas.height:0)||("canvas"==a.relative?canvas.height:world.height),this.x=a.x||0,this.y=a.y||0,this.relative=a.relative||"world",this.opacity=a.opacity||1,this.parallax=a.parallax||1,this.canvas.width!=this.width&&(this.canvas.width=this.width),this.canvas.height!=this.height&&(this.canvas.height=this.height),this.xOffset=0,this.yOffset=0,a.src&&this.context.drawImage(a.src,0,0,this.width,this.height),this.draw=function(a,b,c){return a instanceof CanvasRenderingContext2D||(c=b,b=a,a=context),b="undefined"==typeof b?this.x:b,c="undefined"==typeof c?this.y:c,a.save(),a.globalAlpha=this.opacity,"canvas"==this.relative&&a.translate(world.xOffset,world.yOffset),(this.xOffset||this.yOffset)&&a.translate(this.xOffset,this.yOffset),a.drawImage(this.canvas,b,c),a.restore(),this},this.clear=function(a){return this.context.clear(a),this},this.scroll=function(a,b,c){return c=c||this.parallax,this.xOffset+=-a*c,this.yOffset+=-b*c,this},this.positionOverCanvas=function(){var a=jQuery("<div></div>"),b=$canvas.offset();a.css({left:b.left,pointerEvents:"none",position:"absolute",top:b.top});var c=jQuery(this.canvas);return c.css({backgroundColor:"transparent",margin:"0 auto",overflow:"hidden",pointerEvents:"none",position:"absolute","z-index":50}),a.append(c),jQuery("body").append(a),a},this.showCanvasOverlay=function(){stopAnimating();var a=jQuery("<div></div>");a.css({cursor:"pointer",display:"block",height:"100%",left:0,position:"absolute",top:0,width:"100%"});var b=jQuery(this.canvas);return b.css({border:"1px solid black",display:"block",margin:"0 auto",position:"absolute","z-index":100}).click(function(){a.remove(),startAnimating()}),a.append(b),jQuery("body").append(a),a.click(function(b){3!=b.which&&a.remove()}),a}}function Collection(){this.concat.apply(this,arguments)}function ImageWrapper(a,b,c,d,e){this.src=a,this.x=b,this.y=c,this.width=d,this.height=e,this.draw=function(a){(a||context).drawImage(this.src,this.x,this.y,this.width,this.height)}}function TileMap(a,b,c){var d,e,f,g;this.options={cellSize:[Box.prototype.DEFAULT_WIDTH,Box.prototype.DEFAULT_HEIGHT],gridSize:null,startCoords:c?c.startCoords:void 0},c&&c.cellSize instanceof Array&&c.cellSize.length>1&&(this.options.cellSize=c.cellSize),c&&c.gridSize instanceof Array&&c.gridSize.length>1&&(this.options.gridSize=c.gridSize),("undefined"==typeof b||null===b)&&(b=[]),("undefined"==typeof this.options.startCoords||0===this.options.startCoords.length)&&(this.options.startCoords=[0,world.height-this.options.cellSize[1]*("string"==typeof a?a.split("\n"):a).length]);var h=this.options.gridSize,i=this.options.cellSize[0],j=this.options.cellSize[1],k=this.options.startCoords[0],l=this.options.startCoords[1];if(h instanceof Array&&h.length>0)for(a=new Array(h[0]),d=0;d<h[0];d++)for(a[d]=new Array(h[1]),e=0;e<h[1];e++)a[d][e]=null;if("string"==typeof a)for(a=a.split("\n"),d=0,f=a.length;f>d;d++)a[d]=a[d].split("");for(this.grid=a,"undefined"!=typeof b&&"undefined"==typeof b[" "]&&(b[" "]=null),d=0,f=a.length;f>d;d++)for(e=0,g=a[d].length;g>e;e++)if(null!==a[d][e]){var m=b?b[a[d][e]]:a[d][e];if(null===m||void 0===m)this.grid[d][e]=null;else{var n=k+e*i,o=l+d*j;this.grid[d][e]="string"==typeof m||m instanceof Image||m instanceof HTMLImageElement||m instanceof HTMLCanvasElement||m instanceof Sprite||m instanceof SpriteMap||m instanceof Layer?new ImageWrapper(m,n,o,i,j):m instanceof Function?new(Function.prototype.bind.call(m,null,n,o,i,j)):null}}else this.grid[d][e]=null;this.draw=function(a,b,c){a=a||context;var d,e;{if(!b){for(d=0,e=this.grid.length;e>d;d++)for(var f=0,g=this.grid[d].length;g>f;f++){var h=this.grid[d][f];null!==h&&h.draw(a,c)}return this}var i=this.getCellsInRect();for(d=0,e=i.length;e>d;d++)i[d].draw(a,c)}},this.getCell=function(a,b){return this.grid[a]?this.grid[a][b]:void 0},this.setCell=function(a,b,c){return this.grid[a]&&"undefined"!=typeof this.grid[a][b]&&(this.grid[a][b]=c),this},this.clearCell=function(a,b){return this.grid[a]&&(this.grid[a][b]=null),this},this.getAll=function(){var a=this.grid.length,b=a>0?this.grid[0].length:0,c=[],d,e;for(d=0;a>d;d++)for(e=0;b>e;e++)null!==this.grid[d][e]&&c.push(this.grid[d][e]);return c},this.clearAll=function(){var b=this.grid.length,c=b>0?this.grid[0].length:0,d,e;for(this.grid=new Array(b),d=0;b>d;d++)for(this.grid[d]=new Array(c),e=0;c>e;e++)a[d][e]=null;return this},this.getRows=function(){return this.grid.length},this.getCols=function(){return this.grid.length>0?this.grid[0].length:0},this.forEach=function(a,b){var c=this.grid.length,d=c>0?this.grid[0].length:0,e,f;for(e=0;c>e;e++)for(f=0;d>f;f++)(null!==this.grid[e][f]||b)&&a(this.grid[e][f],e,f)&&("function"==typeof this.grid[e][f].destroy&&this.grid[e][f].destroy(),this.clearCell(e,f));return this},this._getCellCoordsInRect=function(a,b,c,d){"undefined"==typeof a&&(a=world.xOffset),"undefined"==typeof b&&(b=world.yOffset),"undefined"==typeof c&&(c=canvas.width),"undefined"==typeof d&&(d=canvas.height);var e=this.options.startCoords[0],f=this.options.startCoords[1],g=this.options.cellSize[0],h=this.options.cellSize[1],i=(a-e)/g,j=(b-f)/h,k=(a+c-e)/g,l=(f-b+d)/h;return[Math.floor(i),Math.floor(j),Math.ceil(k),Math.ceil(l)]},this.getCellsInRect=function(a,b,c,d){for(var e=this._getCellCoordsInRect(a,b,c,d),f=[],g=Math.min(this.getRows(),Math.max(0,e[1])),h=Math.min(this.getRows(),Math.max(0,e[3])),i=Math.min(this.getCols(),Math.max(0,e[0])),j=Math.min(this.getCols(),Math.max(0,e[2])),k=g,l=h;l>k;k++)for(var m=i,n=j;n>m;m++)null!==this.grid[k][m]&&f.push(this.grid[k][m]);return f},this.getCellCoords=function(a,b){return{row:Math.round((b-this.options.startCoords[1])/this.options.cellSize[1]),col:Math.round((a-this.options.startCoords[0])/this.options.cellSize[0])}},this.getPixelCoords=function(a,b){return{x:this.options.startCoords[0]+this.options.cellSize[0]*a,y:this.options.startCoords[1]+this.options.cellSize[1]*b}}}!function(a){function b(b){if("string"==typeof b.data){var c=b.handler,d=b.data.toLowerCase().split(" ");b.handler=function(b){if(this===b.target||!(/textarea|select/i.test(b.target.nodeName)||a.inArray(b.target.type,a.hotkeys.textTypes)>-1)){var e="keypress"!==b.type&&a.hotkeys.specialKeys[b.which],f=String.fromCharCode(b.which).toLowerCase(),g="",h={};b.altKey&&"alt"!==e&&(g+="alt+"),b.ctrlKey&&"ctrl"!==e&&(g+="ctrl+"),b.metaKey&&!b.ctrlKey&&"meta"!==e&&(g+="meta+"),b.shiftKey&&"shift"!==e&&(g+="shift+"),e?h[g+e]=!0:(h[g+f]=!0,h[g+a.hotkeys.shiftNums[f]]=!0,"shift+"===g&&(h[a.hotkeys.shiftNums[f]]=!0));var i,j;for("keydown"===b.type?(j=e||f,i=a.inArray(j,a.hotkeys.keysDown),(void 0===i||0>i)&&a.hotkeys.keysDown.push(j)):"keyup"===b.type&&(j=e||f,i=a.inArray(j,a.hotkeys.keysDown),void 0!==i&&i>-1&&a.hotkeys.keysDown.splice(i,1),a.hotkeys.lastKeysPressed.push(j),a.hotkeys.lastKeysPressed.length>5&&a.hotkeys.lastKeysPressed.shift()),i=0,l=d.length;l>i;i++)if(h[d[i]])return b.keyPressed=d[i],c.apply(this,arguments)}}}}a.hotkeys={version:"0.9",keysDown:[],lastKeysPressed:[],textTypes:["text","search","tel","url","email","password","number","range","date","month","week","time","datetime","datetime-local","color"],specialKeys:{8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"},areKeysDown:function(b){var c;if("string"==typeof b){var d=b.split(" ");for(c=0;c<d.length;c++)if(this.areKeysDown(d[c].split("+")))return!0;return!1}var e=!1,f=this.keysDown.length;if(f!=b.length)return!1;for(c=0;f>c;c++)if(a.inArray(this.keysDown[c],["alt","ctrl","meta","shift"])>-1){e=!0;break}if(e){for(c=0;f>c;c++)if(-1==a.inArray(this.keysDown[c],b))return!1}else for(c=0;f>c;c++)if(this.keysDown[c]!=b[c])return!1;return!0},lastKeyPressed:function(){return this.lastKeysPressed[this.lastKeysPressed.length-1]}},a.each(["keydown","keyup","keypress"],function(){a.event.special[this]={add:b}}),a(document).keydown("na",function(){}),a(document).keyup("na",function(){})}(this.jQuery),function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),function(){function a(a,b,c){var d="function"==typeof c.postInitCallback?c.postInitCallback:null,e=this;c.postInitCallback=function(a){e.sprite=a,e.baseImage=a.image,e.cachedImages={"00":e.baseImage},e.maps={};for(var c in b)b.hasOwnProperty(c)&&e.set(c,b[c]);d&&d.apply(this,arguments)},this.sprite=new Sprite(a,c),this.sprite.spriteMap=this}a.prototype={set:function(a,b){b instanceof Array&&(b={startRow:b[0],startCol:b[1],endRow:b[2],endCol:b[3],squeeze:b[4],flipped:b[5]}),this.maps[a]={startRow:"undefined"!=typeof b.startRow?b.startRow:0,startCol:"undefined"!=typeof b.startCol?b.startCol:0,endRow:"undefined"!=typeof b.endRow?b.endRow:this.sprite.rows-1,endCol:"undefined"!=typeof b.endCol?b.endCol:this.sprite.cols-1,squeeze:"undefined"!=typeof b.squeeze?b.squeeze:!1,flipped:"undefined"!=typeof b.flipped?b.flipped:{horizontal:!1,vertical:!1}};var c=this.maps[a].flipped,d=(c.horizontal?"1":"0")+(c.vertical?"1":"0");return"undefined"==typeof this.sprite.cachedImages[d]&&(this.sprite.cachedImages[d]=this.sprite._prerender(this.baseImage,c)),this},unset:function(a){return this.maps.hasOwnProperty(a)&&delete this.maps[a],this},use:function(a,b){if(this.activeLoop==a&&!b)return this;this.activeLoop=a;var c=this.maps[a];return this.sprite.setLoop(c.startRow,c.startCol,c.endRow,c.endCol,c.squeeze,c.flipped),this},start:function(a){return a&&this.use(a),this.sprite.startLoop(),this},stop:function(){return this.sprite.stopLoop(),this},reset:function(){return this.sprite.reset(),this},runOnce:function(a,b){return b&&this.use(b),this.sprite.runLoop(a),this},draw:function(a,b,c,d,e){return this.sprite.draw(a,b,c,d,e),this},clone:function(){return new a(this.sprite.sourceFile,this.maps,this.sprite)}},this.SpriteMap=a}.call(this),function(){function a(b,c){if("string"==typeof b){this.sourceFile=b;var d=a.getImageFromCache(b);if(d)this._init(d,c);else{var e=new Image,f=this;e.onload=function(){f._init(this,c)},e._src=b,e.src=b,a.saveImageToCache(b,e)}}else if(b instanceof HTMLImageElement||b instanceof Image){if(!b.src)return;if(this.sourceFile=b._src||b.src,b.complete||b.width&&b.height)a.saveImageToCache(this.sourceFile,b),this._init(b,c);else{if(b._src)return;var g=b.onload,f=this;b.onload=function(){"function"==typeof g&&g(),a.saveImageToCache(f.sourceFile,b),f._init(this,c)}}}else b instanceof HTMLCanvasElement&&this._init(b,c)}a.prototype={_init:function(a,b){this.width=a.width,this.height=a.height,this.frameW=b.frameW||a.width,this.frameH=b.frameH||a.height,this.projectedW=b.projectedW||this.frameW,this.projectedH=b.projectedH||this.frameH,this.rows=Math.floor(this.height/this.frameH),this.cols=Math.floor(this.width/this.frameW),this.startRow=b.startRow||0,this.startCol=b.startCol||0,this.endRow="undefined"==typeof b.endRow?this.rows-1:b.endRow,this.endCol="undefined"==typeof b.endCol?this.cols-1:b.endCol,this.row=this.startRow,this.col=this.startCol,this.frame=1,this.squeeze=b.squeeze||!1,this.interval="undefined"==typeof b.interval?125:b.interval,this.useTimer="undefined"==typeof b.useTimer?!0:b.useTimer,this.advanceFramesManually=b.advanceFramesManually||!1,this.lastFrameUpdateTime=0,this.flipped=b.flipped||{horizontal:!1,vertical:!1},this.flipped.horizontal=this.flipped.horizontal||!1,this.flipped.vertical=this.flipped.vertical||!1,this.cachedImages={"00":a};var c=this.flipped,d=(c.horizontal?"1":"0")+(c.vertical?"1":"0");"undefined"==typeof this.cachedImages[d]&&(this.cachedImages[d]=this._prerender(a,c)),this.image=this.cachedImages[d],this._runOnce=!1,this.squeeze&&(this.cols=this.endCol-this.startCol+1),this.numFrames=this.getNumFrames(),b.postInitCallback&&b.postInitCallback(this)},_prerender:function(a,b){var c=document.createElement("canvas");c.width=this.width,c.height=this.height;var d=c.getContext("2d");return(b.horizontal||b.vertical)&&(d.translate(b.horizontal?c.width:0,b.vertical?c.height:0),d.scale(b.horizontal?-1:1,b.vertical?-1:1)),d.drawImage(a,0,0),c},draw:function(a,b,c,d,e){try{a.save(),d=d||this.projectedW,e=e||this.projectedH;var f=this.col*this.frameW,g=this.row*this.frameH;this.flipped.horizontal&&(f=this.width-f-this.frameW),this.flipped.vertical&&(g=this.height-g-this.frameH),a.drawImage(this.image,f,g,this.frameW,this.frameH,b,c,d,e),a.restore()}catch(h){console&&console.error&&console.error(h)}return!this.useTimer&&!this.advanceFramesManually&&Date.now()-this.lastFrameUpdateTime>this.interval&&this.nextFrame(),this},reset:function(){return this.row=this.startRow,this.col=this.startCol,this.frame=1,this.lastFrameUpdateTime=0,this},changeFrame:function(a){return this.frame+=a,this.setFrame(this.frame),this},setFrame:function(a,b){if("undefined"!=typeof b)this.row=a,this.col=b,this.frame=this.squeeze?this.cols*(this.row-this.startRow+1)-(this.endCol-this.col):this.cols*(this.row-this.startRow+1)-(this.cols-(this.col+1))-this.startCol;else{var c=this.frameNumberToRowCol(a);this.frame=c.frame,this.row=c.row,this.col=c.col}return this.lastFrameUpdateTime=Date.now(),this},setLoop:function(a,b,c,d,e,f){if(this.stopLoop(),(null===c||"undefined"==typeof c)&&(c=this.rows-1),(null===d||"undefined"==typeof d)&&(d=this.cols-1),"undefined"!=typeof e&&(this.squeeze=e),"undefined"!=typeof f){this.flipped=f;var g=this.flipped,h=(g.horizontal?"1":"0")+(g.vertical?"1":"0");"undefined"==typeof this.cachedImages[h]&&(this.cachedImages[h]=this._prerender(this.image,g)),this.image=this.cachedImages[h]}return this.startRow=a,this.startCol=b,this.endRow=c,this.endCol=d,this.reset(),this.numFrames=this.getNumFrames(),this},startLoop:function(a,b,c,d,e,f){if("undefined"!=typeof a&&"undefined"!=typeof b&&this.setLoop(a,b,c,d,e,f),this.lastFrameUpdateTime=Date.now(),this.interval&&this.useTimer){var g=this;this.intervalID=setInterval(function(){g.nextFrame()},this.interval)}return this},stopLoop:function(){return this.lastFrameUpdateTime=0,this.intervalID&&clearInterval(this.intervalID),this},runLoop:function(a,b,c,d,e,f,g){return this.runLoopCallback=a||function(){},this._runOnce=!0,Array.prototype.shift.call(arguments),this.startLoop.apply(this,arguments),this},prevFrame:function(){return changeFrame(-1),this},nextFrame:function(){return this.col++,this.frame++,this.row==this.endRow&&this.col>this.endCol?this._runOnce?(this.stopLoop(),this._runOnce=!1,this.runLoopCallback(this)):this.reset():this.squeeze&&this.col>this.endCol?(this.col=this.startCol,this.row++):!this.squeeze&&this.col>=this.cols&&(this.col=0,this.row++),this.lastFrameUpdateTime=Date.now(),this},getFrame:function(){return{row:this.row,col:this.col,frame:this.frame}},getNumFrames:function(){return this.squeeze?(this.endRow-this.startRow+1)*(this.endCol-this.startCol+1):(this.endRow-this.startRow)*this.cols-this.startCol+this.endCol+1},frameNumberToRowCol:function(a){var b,c;return a=(a+this.numFrames)%this.numFrames||this.numFrames,this.squeeze?(b=this.startRow+Math.floor((a-1)/this.cols),c=(a-1)%this.cols+this.startCol):(b=this.startRow+Math.floor((a+this.startCol-1)/this.cols),c=(a+this.startCol-1)%this.cols),{frame:a,row:b,col:c}},clone:function(){return new a(this.sourceFile,this)}},this.Sprite=a}.call(this),function(){var a={};Sprite.getImageFromCache=function(b){return a[b]?a[b]:null},Sprite.saveImageToCache=function(b,c){a[b]=c},Sprite.preloadImages=function(a,b){var c=a.length,d=-1,e,f,g=function(a,e){d++,"function"==typeof a&&a(e,d,c),d==c&&"function"==typeof b.finishCallback&&b.finishCallback(c)};g();for(var h=function(){Sprite.saveImageToCache(this._src,this),g(b.itemCallback,this._src)};a.length;)e=a.pop(),f=new Image,f._num=c-a.length,f._src=e,f.onload=h,f.src=e}}.call(this);var App={};App.isGameOver=!1,App.debugMode=!1,App.MIN_FPS=4,App.MAX_FPS=100,App.physicsTimeElapsed=0,App.physicsDelta=0,App.Debug={},App.Debug.updateTimeElapsed=0,App.Debug.clearTimeElapsed=0,App.Debug.drawTimeElapsed=0;var canvas,$canvas,context,world;App.setCanvas=function(a){if("string"==typeof a){var b=a;a=document.getElementById(a),a instanceof HTMLCanvasElement||!window.console||!console.warn||console.warn("No canvas with ID "+b+" found.")}if(a instanceof HTMLCanvasElement)"undefined"!=typeof world&&(context.translate(world.xOffset,world.yOffset),world.scaleResolution(1)),canvas=a,$canvas=jQuery(canvas),App.beforeSetup();else{if(canvas instanceof HTMLCanvasElement&&"undefined"!=typeof $canvas)return;if(canvas=document.getElementById("canvas"),!(canvas instanceof HTMLCanvasElement))for(var c=0,d=document.getElementsByTagName("canvas"),e=d.length;e>c;c++)if("false"!=d[c].getAttribute("data-takeover")){canvas=d[c];break}canvas instanceof HTMLCanvasElement||(canvas=document.createElement("canvas")),$canvas=jQuery(canvas),App.isSetup?App.beforeSetup():jQuery(window).load(App.beforeSetup)}},jQuery(document).ready(App.setCanvas),App.beforeSetup=function(){if(App.isSetup=!0,"undefined"!=typeof keys)for(var a in keys)keys.hasOwnProperty(a)&&App.preventDefaultKeyEvents(keys[a].join(" "));App.setDefaultCanvasSize(),context=canvas.getContext("2d"),"undefined"!=typeof Stats&&App.debugMode&&(App.stats=new Stats,App.stats.setMode(0),App.stats.domElement.style.position="absolute",App.stats.domElement.style.left=$canvas.offset().left,App.stats.domElement.style.top=$canvas.offset().top,document.body.appendChild(App.stats.domElement)),Caches.preloadImages("undefined"==typeof preloadables?[]:preloadables,{finishCallback:function(){"undefined"==typeof Events&&"undefined"!=typeof App.Events&&(Events=App.Events),"undefined"==typeof Utils&&"undefined"!=typeof App.Utils&&(Utils=App.Utils),App.reset(!0)}})},App.reset=function(a){stopAnimating(),App.isSomethingBeingDragged&&(App.isSomethingBeingDragged=!1,jQuery(document).trigger("canvasdragstop")),"undefined"!=typeof world&&(context.translate(world.xOffset,world.yOffset),world.scaleResolution(1)),world=new World,context.__layer=world,App.timer=new Timer(!1),App.timer.frames=0,App.isGameOver=!1,App.physicsTimeElapsed=0,App.Debug.updateTimeElapsed=0,App.Debug.clearTimeElapsed=0,App.Debug.drawTimeElapsed=0;var b=setup(!!a);Timer.event("app start"),b!==!1&&startAnimating(),jQuery(document).trigger("start",[!!a])},App.setDefaultCanvasSize=function(){var a=function(){$canvas.css({transform:"scale3d(1, 1, 1)",mozTransform:"scale3d(1, 1, 1)",msTransform:"scale3d(1, 1, 1)",oTransform:"scale3d(1, 1, 1)",webkitTransform:"scale3d(1, 1, 1)"})};if("false"==$canvas.attr("data-resize"))return a(),void 0;var b=jQuery(window);if("full"==$canvas.attr("data-resize"))canvas.width=b.innerWidth()-parseInt($canvas.css("border-left-width"),10)-parseInt($canvas.css("border-right-width"),10)-1,canvas.height=b.innerHeight()-parseInt($canvas.css("border-top-width"),10)-parseInt($canvas.css("border-bottom-width"),10)-1;else{var c=$canvas.attr("data-maxwidth")||canvas.width,d=$canvas.attr("data-minwidth")||canvas.width;canvas.width=Math.min(c,Math.max(b.width(),d));var e=$canvas.attr("data-maxheight")||canvas.height,f=$canvas.attr("data-minheight")||canvas.height;canvas.height=Math.min(e,Math.max(b.height(),f))}var g=$canvas.attr("data-aspectratio")||0;g&&(-1==g.indexOf(":")?g=parseFloat(g):"4:3"==g?g=4/3:"16:9"==g?g=16/9:("16:10"==g||"8:5"==g)&&(g=1.6),canvas.width<canvas.height*g?canvas.height=Math.floor(canvas.width/g):canvas.width>canvas.height*g&&(canvas.width=Math.floor(canvas.height*g))),a()};var Caches={images:{},imagePatterns:{},preloadImages:function(a,b){var c=a.length,d=-1,e,f,g=function(a,e){d++,"function"==typeof a&&a(e,d,c),d==c&&"function"==typeof b.finishCallback&&b.finishCallback(c)};g();for(var h=function(){Caches.images[this._src]=this,g(b.itemCallback,this._src)};a.length;)e=a.pop(),f=new Image,f._num=c-a.length,f._src=e,f.onload=h,f.src=e}};"undefined"!=typeof Sprite&&(Sprite.getImageFromCache=function(a){return Caches.images[a]},Sprite.saveImageToCache=function(a,b){Caches.images[a]=b},Sprite.preloadImages=Caches.preloadImages),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),function(){function a(){"undefined"!=typeof App.stats&&App.stats.begin();var c=App.timer.getDelta();for(App.timer.running||App.timer.start(),App.MIN_FPS&&c>1/App.MIN_FPS&&(jQuery(document).trigger("low_fps",[1/c]),c=1/App.MIN_FPS),App.timer.frames++,App.debugMode&&Timer.event("debug timer update",!0),window.Mouse&&Mouse.Scroll&&Mouse.Scroll._update();c>0&&!App.isGameOver;)App.physicsDelta=Math.min(c,1/App.MAX_FPS),"function"==typeof update&&update(App.physicsDelta,App.physicsTimeElapsed),c-=App.physicsDelta,App.physicsTimeElapsed+=App.physicsDelta;App.debugMode&&(App.Debug.updateTimeElapsed+=Timer.getTimeSince("debug timer update"),Timer.event("debug timer clear",!0)),context.clear(),App.debugMode&&(App.Debug.clearTimeElapsed+=Timer.getTimeSince("debug timer clear"),Timer.event("debug timer draw",!0)),draw(),App.debugMode&&(App.Debug.drawTimeElapsed+=Timer.getTimeSince("debug timer draw")),"undefined"!=typeof App.stats&&App.stats.end(),b&&window.requestAnimFrame(a)}var b=!1,c=!1;window.startAnimating=function(){b||"undefined"==typeof App.timer||(b=!0,jQuery(document).trigger("startAnimating"),a())},window.stopAnimating=function(){if(b&&"undefined"!=typeof App.timer&&(b=!1,App.timer.stop(),jQuery(document).trigger("stopAnimating"),App.debugMode&&console&&console.log)){var a=App.physicsTimeElapsed,c=App.timer.frames,d=App.Debug,e=d.updateTimeElapsed+d.clearTimeElapsed+d.drawTimeElapsed;console.log({"ms/frame":{update:d.updateTimeElapsed/c,clear:d.clearTimeElapsed/c,draw:d.drawTimeElapsed/c,animOps:e/c,other:(a-e)/c,animate:a/c},percent:{update:d.updateTimeElapsed/a*100,clear:d.clearTimeElapsed/a*100,draw:d.drawTimeElapsed/a*100,animOps:e/a*100,other:(a-e)/a*100},fps:c/a})}},window.isAnimating=function(){return b},jQuery(window).on("focus.animFocus",function(){c&&!App.isGameOver&&(c=!1,startAnimating())}),jQuery(window).on("blur.animFocus",function(){stopAnimating(),c=!0})}(),App.preventDefaultKeyEvents=function(a){jQuery.hotkeys?jQuery(document).keydown(a,function(){return!1}):window.console&&console.warn&&console.warn("Tried to prevent default key events but jQuery.hotkeys does not exist.")},window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return Date.now()}}(),function(){var a={},b=0;Timer.event=function(c,d){var e={whileAnimating:d,startTime:d?App.physicsTimeElapsed:performance.now()};"undefined"==typeof c?b=e:a[c]=e},Timer.getTimeSince=function(c){var d="undefined"==typeof a[c]?b:a[c],e=d.whileAnimating?App.physicsTimeElapsed:performance.now();return d.startTime?(e-d.startTime)/1e3:0}}(),App.Utils={},App.Utils.getRandBetween=function(a,b){if(a>b){var c=a;a=b,b=c}return Math.random()*(b-a)+a},App.Utils.getRandIntBetween=function(a,b){if(a>b){var c=a;a=b,b=c}return a=Math.ceil(a),b=Math.floor(b),Math.floor(Math.random()*(b-a+1)+a)},App.Utils.anyIn=function(a,b){for(var c=0,d=a.length;d>c;c++)if(-1!=b.indexOf(a[c]))return!0;return!1},App.Utils.almostEqual=function(a,b,c){return a>=b-c&&b+c>=a},App.Utils.randomString=function(a){var b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_",c="";a=a||32;for(var d=0;a>d;d++)c+=b.charAt(Math.floor(Math.random()*b.length));return c},App.Utils.positionOverCanvas=function(a,b,c){var d=$canvas.offset();return jQuery(a).detach().appendTo("body").css({left:d.left+parseInt($canvas.css("border-left-width"),10)+b+"px",position:"absolute",top:d.top+parseInt($canvas.css("border-top-width"),10)+c+"px","z-index":100})},App.gameOver=function(a){App.isGameOver||(App.isGameOver=!0,stopAnimating(),player&&player.destroy(),"string"!=typeof a&&(a="GAME OVER"),setTimeout(function(){context.save(),context.font="100px Arial",context.fillStyle="black",context.strokeStyle="lightGray",context.textBaseline="middle",context.textAlign="center",context.shadowColor="black",context.shadowBlur=8,context.lineWidth=5;var b=Math.round(world.xOffset+canvas.width/2),c=Math.round(world.yOffset+canvas.height/2);context.strokeText(a,b,c),context.fillText(a,b,c),context.restore()},100),$canvas.css("cursor","pointer"),$canvas.one("click.gameover",function(a){a.preventDefault(),$canvas.css("cursor","auto"),App.reset()}))},Array.prototype.remove=function(a){var b=this.indexOf(a);return void 0===b||0>b?void 0:this.splice(b,1)},Number.prototype.round=function(a,b){"undefined"==typeof b&&(b=a,a=this),b||(b=0);var c=Math.pow(10,0|b);return Math.round(a*c)/c},Number.prototype.sign=function(a){return"undefined"==typeof a&&(a=this),a>0?1:0>a?-1:0},CanvasRenderingContext2D.prototype.clear=function(a){this.save();var b=0,c=0;this.__layer?(b=this.__layer.xOffset,c=this.__layer.yOffset):this.setTransform(1,0,0,1,0,0),a?(this.fillStyle=a,this.fillRect(b,c,this.canvas.width,this.canvas.height)):this.clearRect(b,c,this.canvas.width,this.canvas.height),this.restore()},CanvasRenderingContext2D.prototype.__drawImage=CanvasRenderingContext2D.prototype.drawImage,CanvasRenderingContext2D.prototype.drawImage=function(a,b,c,d,e,f,g,h,i,j){arguments.length%2===0&&(j=Array.prototype.pop.call(arguments),d instanceof Function?d=void 0:f instanceof Function?f=void 0:h instanceof Function&&(h=void 0),"function"!=typeof j&&(j=void 0));var k=this,l=arguments;"number"!=typeof f&&"undefined"==typeof g&&"number"!=typeof h&&"undefined"==typeof i&&(f=b,g=c,"number"==typeof d&&"undefined"!=typeof e&&(h=d,i=e),b=void 0,c=void 0,d=void 0,e=void 0);var m=function(a,b,c,d,e,f,g,h,i){d&&e?h&&i?k.__drawImage(a,f,g,h,i,b,c,d,e):k.__drawImage(a,b,c,d,e):k.__drawImage(a,b,c),j instanceof Function&&j.call(k,l,!0)},n;if("undefined"!=typeof Sprite&&a instanceof Sprite||"undefined"!=typeof SpriteMap&&a instanceof SpriteMap)a.draw(this,f,g,h,i),j instanceof Function&&j.call(k,l,!0);else if("undefined"!=typeof Layer&&a instanceof Layer){k.save(),k.globalAlpha=a.opacity,"canvas"==a.relative&&k.translate(world.xOffset,world.yOffset);var o=j;j=void 0,m(a.canvas,f,g,h,i,b,c,d,e),k.restore(),j=o,j instanceof Function&&j.call(k,l,!0)}else if(a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement)m(a,f,g,h,i,b,c,d,e);else if(a instanceof HTMLImageElement||a instanceof Image){if(n=a,a=n._src||n.src,!a)return j instanceof Function&&j.call(k,l,!1),void 0;if(Caches.images[a]||(Caches.images[a]=n),n.complete||n.width&&n.height)m(n,f,g,h,i,b,c,d,e);else{if(n._src)return;var p=n.onload;n.onload=function(){"function"==typeof p&&p(),j instanceof Function&&j.call(k,l,!1)}}}else if("string"==typeof a&&Caches.images[a])n=Caches.images[a],(n.complete||n.width&&n.height)&&m(n,f,g,h,i,b,c,d,e);else{if("string"!=typeof a)throw new TypeMismatchError("Image type not recognized.");n=new Image,n.onload=function(){j instanceof Function&&j.call(k,l,!1)},n._src=a,n.src=a,Caches.images[a]=n}},CanvasRenderingContext2D.prototype.drawPattern=function(a,b,c,d,e,f,g){"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=0),"undefined"==typeof d&&(d=this.canvas.width),"undefined"==typeof e&&(e=this.canvas.height),"function"==typeof f?(g=f,f="repeat"):f||(f="repeat"),"undefined"!=typeof Layer&&a instanceof Layer&&(a=a.canvas);var h;if(a instanceof CanvasPattern)this.fillStyle=a,this.fillRect(b,c,d,e),g instanceof Function&&g.call(this,arguments,!0);else if("undefined"!=typeof Layer&&a instanceof Layer)this.save(),this.globalAlpha=a.opacity,"canvas"==a.relative&&this.translate(world.xOffset,world.yOffset),this.fillStyle=this.createPattern(a.canvas,f),this.fillRect(b,c,d,e),this.restore(),g instanceof Function&&g.call(this,arguments,!0);else if(a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement)this.fillStyle=this.createPattern(a,f),this.fillRect(b,c,d,e),g instanceof Function&&g.call(this,arguments,!0);
else if(a instanceof HTMLImageElement||a instanceof Image){if(h=a,a=h._src||h.src,!a)return g instanceof Function&&g.call(this,arguments,!1),void 0;if(Caches.imagePatterns[a])return this.fillStyle=Caches.imagePatterns[a],this.fillRect(b,c,d,e),g instanceof Function&&g.call(this,arguments,!0),this.fillStyle;if(Caches.images[a]||(Caches.images[a]=h),h.complete||h.width&&h.height)this.fillStyle=this.createPattern(h,f),this.fillRect(b,c,d,e),Caches.imagePatterns[a]=this.fillStyle,g instanceof Function&&g.call(this,arguments,!0);else{if(h._src)return;var i=this,j=h.onload;h.onload=function(){"function"==typeof j&&j(),Caches.imagePatterns[a]=this.createPattern(h,f),g instanceof Function&&g.call(i,arguments,!1)}}}else if("string"==typeof a)if(Caches.imagePatterns[a])this.fillStyle=Caches.imagePatterns[a],this.fillRect(b,c,d,e),g instanceof Function&&g.call(this,arguments,!0);else if(Caches.images[a])h=Caches.images[a],(h.complete||h.width&&h.height)&&(this.fillStyle=this.createPattern(h,f),this.fillRect(b,c,d,e),Caches.imagePatterns[a]=this.fillStyle,g instanceof Function&&g.call(this,arguments,!0));else{var k=this;h=new Image,h.onload=function(){Caches.imagePatterns[a]=this.createPattern(h,f),g instanceof Function&&g.call(k,arguments,!1)},h._src=a,h.src=a,Caches.images[a]=h}return Caches.imagePatterns[a]?Caches.imagePatterns[a]:void 0},CanvasRenderingContext2D.prototype.drawCheckered=function(a,b,c,d,e,f,g){if("undefined"==typeof a&&(a=80),"string"==typeof a&&"string"==typeof b){var h=a,i=b;a=c,b=d,c=e,d=f,e=g,f=h,g=i}var j=document.createElement("canvas"),k=j.getContext("2d");return j.width=2*a,j.height=2*a,k.fillStyle=f||"silver",k.fillRect(0,0,a,a),k.fillRect(a,a,a,a),k.fillStyle=g||"lightGray",k.fillRect(a,0,a,a),k.fillRect(0,a,a,a),this.drawPattern(j,b||0,c||0,d||this.canvas.width,e||this.canvas.height)},CanvasRenderingContext2D.prototype.circle=function(a,b,c,d,e){this.beginPath(),this.arc(a,b,c,0,2*Math.PI,!1),null!==d&&(d&&(this.fillStyle=d),this.fill()),void 0!==e&&(this.lineWidth=Math.max(Math.ceil(c/15),1),e&&(this.strokeStyle=e),this.stroke())},App.isSomethingBeingDragged=!1;var Mouse={Coords:{x:-9999,y:-9999,physicalX:-9999,physicalY:-9999,worldX:function(){return this.x>=0?this.x+world.xOffset:-9999},worldY:function(){return this.y>=0?this.y+world.yOffset:-9999}}};jQuery(document).ready(function(){var a=function(a){try{var b=a.pageX||a.originalEvent.touches[0].pageX,c=a.pageY||a.originalEvent.touches[0].pageY;"touchmove"==a.type&&a.preventDefault(),Mouse.Coords.physicalX=b-$canvas.offset().left,Mouse.Coords.physicalY=c-$canvas.offset().top,Mouse.Coords.x=Math.round(Mouse.Coords.physicalX*world._actualXscale),Mouse.Coords.y=Math.round(Mouse.Coords.physicalY*world._actualYscale)}catch(d){}};$canvas.on("touchmove.coords",a),$canvas.hover(function(){jQuery(this).on("mousemove.coords",a)},function(){jQuery(this).off("mousemove.coords"),Mouse.Coords.physicalX=-9999,Mouse.Coords.physicalY=-9999,Mouse.Coords.x=-9999,Mouse.Coords.y=-9999}),$canvas.on("mousedown mouseup click touchstart touchend",function(b){"touchstart"==b.type&&a(b),isAnimating()&&"undefined"!=typeof App.Events&&App.Events.trigger(b.type,b)}),$canvas.on("mouseup.drag touchend.drag",function(a){"undefined"!=typeof App.Events&&App.Events.trigger("canvasdragstop",a),App.isSomethingBeingDragged=!1,jQuery(document).trigger("canvasdragstop")}),jQuery(document).on("canvasdrop",function(a,b){"undefined"!=typeof App.Events&&App.Events.trigger("canvasdrop",a,b)})}),App.isHovered=function(a){return Mouse.Coords.worldX()>a.x&&Mouse.Coords.worldX()<a.x+a.width&&Mouse.Coords.worldY()>a.y&&Mouse.Coords.worldY()<a.y+a.height},Mouse.Scroll=function(){function a(){var a,d,e=g;return Mouse.Coords.x<canvas.width*b?(d=j(Mouse.Coords.x/(canvas.width*b)),a=Math.round(d*Math.min(world.xOffset,c*App.physicsDelta)),world.xOffset-=a,h.x-=a,context.translate(a,0)):Mouse.Coords.x>canvas.width*(1-b)&&(d=j((canvas.width-Mouse.Coords.x)/(canvas.width*b)),a=Math.round(d*Math.min(world.width-canvas.width-world.xOffset,c*App.physicsDelta)),world.xOffset+=a,h.x+=a,context.translate(-a,0)),Mouse.Coords.y<canvas.height*b?(d=j(Mouse.Coords.y/(canvas.height*b)),a=Math.round(d*Math.min(world.yOffset,c*App.physicsDelta)),world.yOffset-=a,h.y-=a,context.translate(0,a)):Mouse.Coords.y>canvas.height*(1-b)&&(d=j((canvas.height-Mouse.Coords.y)/(canvas.height*b)),a=Math.round(d*Math.min(world.height-canvas.height-world.yOffset,c*App.physicsDelta)),world.yOffset+=a,h.y+=a,context.translate(0,-a)),g=0!==h.x&&0!==h.y,!e&&g?jQuery(document).trigger("mousescrollon"):e&&!g&&jQuery(document).trigger("mousescrolloff"),h}var b=.2,c=350,d=!1,e=!1,f=!1,g=!1,h={x:0,y:0},i={THRESHOLD:function(){return 1},LINEAR:function(a){return 1-a},SMOOTH:function(a){return.5-Math.cos((1-a)*Math.PI)/2},EXPONENTIAL:function(a){return Math.sqrt(1-a)}},j=i.SMOOTH;return{enable:function(){d||(d=!0,$canvas.one("mousemove.translate",function(){Mouse.Coords.x>=0&&Mouse.Coords.y>=0&&(e=!0,a())}),$canvas.on("mouseenter.translate touchstart.translate",function(){e=!0,a()}),$canvas.on("mouseleave.translate touchleave.translate",function(){e=!1,g&&(g=!1,jQuery(document).trigger("mousescrolloff"))}),$canvas.on("mousedown.translate touchstart.translate",function(){f=!0}),$canvas.on("mouseup.translate touchend.translate",function(){f=!1}))},disable:function(){$canvas.off(".translate"),e=!1,d=!1,g=!1},isEnabled:function(){return d},isScrolling:function(){return g},_update:function(){return e&&!f?a():void 0},easings:i,setEasingFunction:function(a){j=a},getEasingFunction:function(){return j},setThreshold:function(a){b=a},getThreshold:function(){return b},setScrollDistance:function(a){c=a},getScrollDistance:function(){return c}}}(),function(){function a(){return"function"!=typeof App.isHovered?(window.console&&console.warn&&console.warn("Mouse event triggered, but App.isHovered does not exist."),!1):App.isHovered(this)}var b={};App.Events={listen:function(a,c,d,e){var f=arguments[4],g=c.split(" ");if(!(g.length>1)){var h="",i=c.indexOf(".");return-1!==i&&(h=c.substring(i+1),c=c.substring(0,i)),b[c]||(b[c]=[]),b[c].push({object:a,callback:function(){d.apply(a,arguments)},namespace:h,weight:e||0,once:f||!1}),a}for(var j=0,k=g.length;k>j;j++)App.Events.listen(a,g[j],d,e,f)},once:function(a,b,c,d){return App.Events.listen(a,b,c,d,!0)},unlisten:function(a,c){var d=c.split(" ");{if(!(d.length>1)){var e="",f=c.indexOf("."),g;if(-1!==f&&(e=c.substring(f+1),c=c.substring(0,f)),c&&b[c])for(g=b[c],f=g.length-1;f>=0;f--)g[f].object!=a||e&&g[f].namespace!=e||b[c].splice(f,1);else if(!c&&e)for(c in b)if(b.hasOwnProperty(c))for(g=b[c],f=g.length-1;f>=0;f--)g[f].object==a&&g[f].namespace==e&&b[c].splice(f,1);return a}for(var h=0,i=d.length;i>h;h++)App.Events.unlisten(a,d[h])}},trigger:function(){var a=Array.prototype.shift.call(arguments),c=arguments[0],d=b[a];if(d){d.sort(function(a,b){return b.weight-a.weight});for(var e=d.length-1;e>=0&&(App.Events.Behaviors[a]&&!App.Events.Behaviors[a].apply(d[e].object,arguments)||(d[e].callback.apply(d[e].object,arguments),d[e].once&&App.Events.unlisten(d[e].object,a+"."+d[e].namespace),!(c&&c.isPropagationStopped&&c.isPropagationStopped())));e--);}},Behaviors:{mousedown:a,mouseup:a,click:a,touchstart:a,touchend:a,canvasdragstop:function(){return!!this.isBeingDragged},canvasdrop:function(a,b){return this===b}}}}.call(this),App.Storage=function(a,b){var c={enabled:!0},d="__appstore__",e=a.localStorage,f={},g=!1;c.set=function(a,f){return a=d+a,f===b?c.remove(a):(e.setItem(a,JSON.stringify(f)),void 0)},c.get=function(a,b){a=d+a;try{var c=e.getItem(a);if("string"==typeof c)return JSON.parse(c);if(null!==c)return c}catch(f){console&&console.error&&console.error(f)}return b},c.remove=function(a){e.removeItem(d+a)},c.clear=function(){e.clear()},c.length=function(){return g?f.length:e.length},c.key=function(a){return e.key(a)},c.isEnabled=function(){return c.enabled};try{c.set(d,d),c.get(d)!=d&&(c.enabled=!1),c.remove(d)}catch(h){c.enabled=!1}return c.enabled||(e={setItem:function(a,b){f[a]=b},getItem:function(a){return f[a]},removeItem:function(a){delete f[a]},clear:function(){f={}},key:function(a){var b=0;for(var c in f)if(f.hasOwnProperty(c)){if(b==a)return f[c];b++}}}),c}(window),Collection.prototype={length:0,draw:function(a){a=a||context;for(var b=0;b<this.length;b++)this[b].draw(a);return this},forEach:function(a){if("string"==typeof a)return this._executeMethod.apply(this,arguments);for(var b=this.length-1;b>=0;b--)a(this[b])&&("function"==typeof this[b].destroy&&this[b].destroy(),this.splice(b,1));return this},_executeMethod:function(){for(var a=Array.prototype.shift.call(arguments),b=0;b<this.length;b++)this[b][a].apply(this[b],arguments);return this},collideAll:function(a){for(var b=!1,c=0,d=this.length;d>c;c++)for(var e=c+1;d>e;e++)if(this[c].overlaps(this[e])){if("function"!=typeof a)return!0;a.call(this,this[c],this[e]),b=!0}return b},splice:Array.prototype.splice,add:Array.prototype.push,concat:function(){for(var a=0,b=arguments.length;b>a;a++)if(arguments[a]instanceof Array||arguments[a]instanceof Collection)for(var c=0,d=arguments[a].length;d>c;c++)Array.prototype.push.call(this,arguments[a][c]);else Array.prototype.push.call(this,arguments[a]);return this},remove:Array.prototype.remove,removeLast:Array.prototype.pop,removeFirst:Array.prototype.shift,removeAll:function(){return Array.prototype.splice.call(this,0,this.length),this},indexOf:Array.prototype.indexOf};var Box=Class.extend({init:function(a,b,c,d,e){this.x="undefined"!=typeof a?a:Math.floor((world.width-this.DEFAULT_WIDTH)/2),this.y="undefined"!=typeof b?b:Math.floor((world.height-this.DEFAULT_HEIGHT)/2),this.width=c||this.DEFAULT_WIDTH,this.height=d||this.DEFAULT_HEIGHT,this.fillStyle=e||"black"},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:80,src:null,radians:0,draw:function(a,b){a=a||context,"undefined"==typeof b&&(b=!0),a.save(),a.fillStyle=this.fillStyle;var c=this.x,d=this.y,e=this.width,f=this.height;b&&(c=Math.round(c),d=Math.round(d)),this.radians&&(a.translate(c+e/2,d+f/2),a.rotate(this.radians),a.translate(-e/2-c,-f/2-d)),this.src?a.drawImage(this.src,c,d,e,f):this.drawDefault(a,c,d,e,f),a.restore()},drawDefault:function(a,b,c,d,e){a.fillRect(b,c,d,e)},drawBoundingBox:function(a,b){a=a||context,b&&(a.strokeStyle=b),a.strokeRect(this.x,this.y,this.width,this.height)},xC:function(){return this.x+this.width/2},yC:function(){return this.y+this.height/2},collides:function(a,b,c){if(a instanceof Box&&(a!==this||!c))return this.overlaps(a)?a:!1;var d=a,e=[];"undefined"!=typeof TileMap&&a instanceof TileMap&&(d=a.getAll());for(var f=0,g=d.length;g>f;f++)if(this.overlaps(d[f])&&(d[f]!==this||!c)){if(!b)return d[f];e.push(d[f])}return e.length?e:!1},overlaps:function(a){return this.overlapsX(a)&&this.overlapsY(a)},overlapsX:function(a){return this.x+this.width>a.x&&a.x+a.width>this.x},overlapsY:function(a){return this.y+this.height>a.y&&a.y+a.height>this.y},isHovered:function(){return"function"!=typeof App.isHovered?(window.console&&console.warn&&console.warn("Box#isHovered called, but App.isHovered does not exist."),!1):App.isHovered(this)},listen:function(a,b,c){return App.Events?App.Events.listen(this,a,b,c):window.console&&console.warn&&console.warn("Box#listen called, but App.Events does not exist."),this},once:function(a,b,c){return App.Events?App.Events.once(this,a,b,c):window.console&&console.warn&&console.warn("Box#once called, but App.Events does not exist."),this},unlisten:function(a){return App.Events?App.Events.unlisten(this,a):window.console&&console.warn&&console.warn("Box#unlisten called, but App.Events does not exist."),this},destroy:function(){},stoodOn:null}),Actor=Box.extend({MOVEAMOUNT:400,GRAVITY:!1,G_CONST:21,JUMP_VEL:500,JUMP_DELAY:.25,AIR_CONTROL:.25,JUMP_RELEASE:!1,MULTI_JUMP:0,CONTINUOUS_MOVEMENT:!1,STAY_IN_WORLD:!0,DAMPING_FACTOR:null,lastLooked:[],isBeingDragged:!1,dropTargets:[],xVelocity:0,yVelocity:0,xAcceleration:0,yAcceleration:0,keys:void 0,lastJump:0,lastDirection:[],jumpDirection:{right:!1,left:!1},jumpKeyDown:!1,numJumps:0,inAir:!1,fallLeft:null,isDraggable:!1,dragStartX:0,dragStartY:0,animLoop:"",init:function(){this._super.apply(this,arguments),this.lastX=this.x,this.lastY=this.y,this.lastDirection=[],this.lastLooked=[],this.jumpDirection={right:!1,left:!1},this.dropTargets=[],arguments.length<5&&(this.fillStyle="lightBlue")},draw:function(){return this.src instanceof SpriteMap&&this.animLoop&&this.src.use(this.animLoop),this._super.apply(this,arguments)},drawDefault:function(a,b,c,d,e){b+=d/2,c+=e/2;var f=(d+e)/4;a.circle(b,c,f,this.fillStyle,"black"),a.beginPath(),a.arc(b,c,.6*f,.1*Math.PI,.9*Math.PI,!1),a.lineWidth=Math.max(Math.ceil(f/15),1),a.strokeStyle="black",a.stroke(),a.beginPath(),a.arc(b-.3*f,c-.25*f,Math.max(Math.ceil(f/15),1),0,2*Math.PI,!1),a.fillStyle="black",a.fill(),a.arc(b+.3*f,c-.25*f,Math.max(Math.ceil(f/15),1),0,2*Math.PI,!1),a.fill()},update:function(a){this.lastX=this.x,this.lastY=this.y,this.isBeingDragged&&window.Mouse?(this.x=Mouse.Coords.worldX()-this.width/2,this.y=Mouse.Coords.worldY()-this.height/2):(this.processInput(a),this.ambientAcceleration(),this.move(),App.Utils.almostEqual(this.lastX,this.x,1e-6)&&(this.fallLeft=null),!this.GRAVITY||this.y+this.height==world.height&&this.STAY_IN_WORLD||this.startFalling()),this.updateAnimation(),this.dampVelocity()},processInput:function(a){var b=!1,c=!1,d=!1,e=App.Utils.anyIn,f=this.keys||window.keys;if("undefined"!=typeof f){if("undefined"==typeof a||0===a.length){if(!this.CONTINUOUS_MOVEMENT)return;a=this.lastLooked}if(this.lastDirection=a.slice(),e(f.left,a)?(b=!0,d=!0,this.fallLeft=!0,this.GRAVITY&&this.isInAir()?(this.jumpDirection.right||!this.jumpDirection.left)&&(this.xVelocity=-this.MOVEAMOUNT*this.AIR_CONTROL,this.jumpDirection.right=!1,this.jumpDirection.left=!1):this.xVelocity=-this.MOVEAMOUNT):e(f.right,a)&&(c=!0,d=!0,this.fallLeft=!1,this.GRAVITY&&this.isInAir()?(this.jumpDirection.left||!this.jumpDirection.right)&&(this.xVelocity=this.MOVEAMOUNT*this.AIR_CONTROL,this.jumpDirection.right=!1,this.jumpDirection.left=!1):this.xVelocity=this.MOVEAMOUNT),e(f.up,a)){if(this.GRAVITY){if(!this.isInAir()||this.MULTI_JUMP>this.numJumps||-1==this.MULTI_JUMP){var g=App.physicsTimeElapsed;!(g-this.lastJump>this.JUMP_DELAY)||this.JUMP_RELEASE&&this.jumpKeyDown||(this.yVelocity=-this.JUMP_VEL,this.yAcceleration=0,this.lastJump=g,this.jumpDirection.right=c,this.jumpDirection.left=b,this.numJumps++,this.inAir=!0)}}else this.yVelocity=-this.MOVEAMOUNT,d=!0;this.jumpKeyDown=!0}else e(f.down,a)&&(this.isInAir()&&this.GRAVITY||(this.yVelocity=this.MOVEAMOUNT,d=!0));if(d&&(this.lastLooked=a.slice(),this.GRAVITY))for(var h=this.lastLooked.length-1;h>=0;h--)-1==f.left.indexOf(this.lastLooked[h])&&-1==f.right.indexOf(this.lastLooked[h])&&this.lastLooked.splice(h,1)}},ambientAcceleration:function(){this.GRAVITY&&(this.isInAir()?(this.yAcceleration+=this.G_CONST,this.jumpDirection.left?this.xVelocity=-this.MOVEAMOUNT:this.jumpDirection.right&&(this.xVelocity=this.MOVEAMOUNT)):this.stopFalling())},move:function(){var a=App.physicsDelta,b=a/2;this.xVelocity+=this.xAcceleration*b,this.yVelocity+=this.yAcceleration*b;var c=this.xVelocity,d=this.yVelocity;if(0!==c&&0!==d&&!this.GRAVITY){var e=Math.max(Math.abs(c),Math.abs(d)),f=Math.sqrt(c*c+d*d),g=e/f;this.xVelocity*=g,this.yVelocity*=g}this.x+=this.xVelocity*a,this.y+=this.yVelocity*a,this.xVelocity+=this.xAcceleration*b,this.yVelocity+=this.yAcceleration*b,this.stayInWorld()},stayInWorld:function(){this.STAY_IN_WORLD&&(this.x<0?this.x=0:this.x+this.width>world.width&&(this.x=world.width-this.width),this.y<0?this.y=0:this.y+this.height>world.height&&(this.y=world.height-this.height,this.stopFalling()))},dampVelocity:function(){return null===this.DAMPING_FACTOR||App.Utils.almostEqual(this.xVelocity,0,1e-4)?(this.xVelocity=0,this.GRAVITY||(this.yVelocity=0),void 0):(this.xVelocity*=1-this.DAMPING_FACTOR*App.physicsDelta,this.GRAVITY||App.Utils.almostEqual(this.yVelocity,0,1e-4)||(this.yVelocity*=1-this.DAMPING_FACTOR*App.physicsDelta),void 0)},addVelocityVector:function(a,b){this.xVelocity+=b*Math.cos(a),this.yVelocity+=b*Math.sin(a)},setVelocityVector:function(a,b){this.xVelocity=b*Math.cos(a),this.yVelocity=b*Math.sin(a)},getVelocityVector:function(){return{magnitude:Math.sqrt(this.xVelocity*this.xVelocity+this.yVelocity*this.yVelocity),direction:Math.atan2(this.yVelocity,this.xVelocity)}},addAccelerationVector:function(a,b){this.xAcceleration+=b*Math.cos(a),this.yAcceleration+=b*Math.sin(a)},setAccelerationVector:function(a,b){this.xAcceleration=b*Math.cos(a),this.yAcceleration=b*Math.sin(a)},getAccelerationVector:function(){return{magnitude:Math.sqrt(this.xVelocity*this.xVelocity+this.yVelocity*this.yVelocity),direction:Math.atan2(this.yVelocity,this.xVelocity)}},moveOutside:function(a){var b=Math.min(this.x+this.width-a.x,a.x+a.width-this.x),c=Math.min(this.y+this.height-a.y,a.y+a.height-this.y);return c>=b?{x:this.moveOutsideX(a),y:this.moveOutsideY(a)}:{y:this.moveOutsideY(a),x:this.moveOutsideX(a)}},moveOutsideX:function(a){var b=0,c;return this.overlaps(a)&&(c=this.x+this.width/2<a.x+a.width/2?a.x-this.width-.01:a.x+a.width+.01,b=c-this.x,this.x=c),b},moveOutsideY:function(a){var b=0,c;return this.overlaps(a)&&(c=this.y+this.height/2<=a.y+a.height/2?a.y-this.height-1:a.y+a.height+1,b=c-this.y,this.y=c),b},startFalling:function(){this.inAir||null===this.fallLeft||(this.jumpDirection.left=this.fallLeft,this.jumpDirection.right=!this.fallLeft),this.inAir=!0},stopFalling:function(){this.yAcceleration>0&&(this.yAcceleration=0),this.yVelocity>0&&(this.yVelocity=0),this.numJumps=0,this.inAir=!1},isInAir:function(){return this.inAir},isJumping:function(){return this.numJumps>0},isFalling:function(){return this.isInAir()&&0===this.numJumps},hasAirMomentum:function(){return null!==this.fallLeft||this.jumpDirection.left||this.jumpDirection.right},standingOn:function(a){if("undefined"!=typeof Collection&&a instanceof Collection||"undefined"!=typeof TileMap&&a instanceof TileMap){for(var b=a.getAll(),c=0,d=b.length;d>c;c++)if(this.standingOn(b[c]))return!0;return!1}return this.overlapsX(a)&&App.Utils.almostEqual(this.y+this.height,a.y,1)},collideSolid:function(a){var b={x:0,y:0};if(a instanceof Box||a instanceof ImageWrapper)b=this._collideSolidBox(a);else if("undefined"!=typeof Collection&&a instanceof Collection||"undefined"!=typeof TileMap&&a instanceof TileMap)for(var c=a.getAll(),d=0,e=c.length;e>d;d++){var f=this._collideSolidBox(c[d]);f.x&&(b.x=f.x),f.y&&(b.y=f.y)}return b.x=!!b.x,b.y=!!b.y,this.updateAnimation(b),b},_collideSolidBox:function(a){var b=!0,c={x:0,y:0};if(this.overlaps(a)&&(c=this.moveOutside(a)),this.GRAVITY){var d=this.x;this.x=this.lastX,this.standingOn(a)&&(this.stopFalling(),b=!1,"function"==typeof a.stoodOn&&a.stoodOn(this)),this.x=d,b&&(c.x||c.y)&&(App.Utils.almostEqual(this.y,a.y+a.height,1)?(this.yAcceleration<0&&(this.yAcceleration=0),this.yVelocity<0&&(this.yVelocity=0)):(this.jumpDirection.left=!1,this.jumpDirection.right=!1))}return c},updateAnimation:function(a){if(this.src instanceof SpriteMap){var b=this.keys||window.keys,c=this.lastDirection,d=App.Utils.anyIn,e="undefined"!=typeof b;e&&"undefined"!=typeof b.shoot&&d(b.shoot,c)&&(c=this.lastLooked),this.isBeingDragged?this.useAnimation("drag","stand"):this.isInAir()?this.x>this.lastX?this.useAnimation("jumpRight","lookRight","stand"):this.x<this.lastX?this.useAnimation("jumpLeft","lookLeft","stand"):this.isJumping()?this.useAnimation("jump","stand"):this.useAnimation("fall","stand"):this.y>this.lastY?this.x>this.lastX?this.useAnimation("downRight","stand"):this.x<this.lastX?this.useAnimation("downLeft","stand"):this.useAnimation("down","stand"):this.y<this.lastY?this.x>this.lastX?this.useAnimation("upRight","stand"):this.x<this.lastX?this.useAnimation("upLeft","stand"):this.useAnimation("up","stand"):this.x>this.lastX?this.useAnimation("right","stand"):this.x<this.lastX?this.useAnimation("left","stand"):e&&d(b.up,c)?d(b.right,c)?this.useAnimation("lookUpRight","stand"):d(b.left,c)?this.useAnimation("lookUpLeft","stand"):this.useAnimation("lookUp","stand"):e&&d(b.down,c)?d(b.right,c)?this.useAnimation("lookDownRight","stand"):d(b.left,c)?this.useAnimation("lookDownLeft","stand"):this.useAnimation("lookDown","stand"):e&&d(b.right,c)?this.useAnimation(a&&a.x?"right":"lookRight","stand"):e&&d(b.left,c)?this.useAnimation(a&&a.x?"left":"lookLeft","stand"):this.useAnimation("stand")}},useAnimation:function(){if("undefined"!=typeof this.src.maps){for(var a=0;a<arguments.length;a++){var b=arguments[a];if(this.src.maps[b])return this.animLoop=b,b}return!1}},setDraggable:function(a){return this.isDraggable&&a?this:a?App.Events?window.Mouse?(this.isDraggable=!0,this.listen("mousedown.drag touchstart.drag",function(){App.isSomethingBeingDragged=!0,this.isBeingDragged=!0,this.dragStartX=this.x,this.dragStartY=this.y,jQuery(document).trigger("canvasdragstart",[this])}),this.listen("canvasdragstop.drag",function(){this.isBeingDragged=!1;var a=this.collides(this.dropTargets);this.dropTargets.length&&!a?(this.x=this.dragStartX,this.y=this.dragStartY):a&&jQuery(document).trigger("canvasdrop",[a])}),this):(window.console&&console.warn&&console.warn("Actor#setDraggable called, but window.Mouse does not exist."),this):(window.console&&console.warn&&console.warn("Actor#setDraggable called, but App.Events does not exist."),this):(this.isDraggable=!1,this.unlisten(".drag"),this)},getDraggable:function(){return this.isDraggable},release:function(a){var b=this.keys||window.keys;this.GRAVITY&&"undefined"!=typeof b&&App.Utils.anyIn(b.up,a)&&(this.jumpKeyDown=!1)}}),Player=Actor.extend({MOVEWORLD:.45,JUMP_RELEASE:!0,init:function(){this._super.apply(this,arguments),arguments.length>0&&world.centerViewportAround(this.x,this.y);var a=this;this.__keytracker=function(){jQuery.hotkeys&&a.release([jQuery.hotkeys.lastKeyPressed()])},jQuery(document).on("keyup.release",this.__keytracker)},processInput:function(a){return"undefined"==typeof a&&jQuery.hotkeys&&(a=jQuery.hotkeys.keysDown),this._super(a)},update:function(a){this._super(a),this.isBeingDragged||this.adjustViewport()},setDraggable:function(a){return a&&!this.isDraggable&&App.Events&&window.Mouse&&this.listen("canvasdragstop.drag",function(){!this.isBeingDragged||this.dropTargets.length&&!this.collides(this.dropTargets)||world.centerViewportAround(this.x,this.y)},-1),this._super.apply(this,arguments)},adjustViewport:function(){var a=world.xOffset,b=world.yOffset,c={x:0,y:0};return window.Mouse&&Mouse.Scroll.isEnabled()?c:(a>0&&this.x+this.width/2-a<canvas.width*this.MOVEWORLD?(world.xOffset=Math.max(a+(this.x-this.lastX),0),context.translate(a-world.xOffset,0),c.x=a-world.xOffset):a<world.width-canvas.width&&this.x+this.width/2-a>canvas.width*(1-this.MOVEWORLD)&&(world.xOffset=Math.min(a+(this.x-this.lastX),world.width-canvas.width),context.translate(a-world.xOffset,0),c.x=a-world.xOffset),b>0&&this.y+this.height/2-b<canvas.height*this.MOVEWORLD?(world.yOffset=Math.max(b+(this.y-this.lastY),0),context.translate(0,b-world.yOffset),c.y=b-world.yOffset):b<world.height-canvas.height&&this.y+this.height/2-b>canvas.height*(1-this.MOVEWORLD)&&(world.yOffset=Math.min(b+(this.y-this.lastY),world.height-canvas.height),context.translate(0,b-world.yOffset),c.y=b-world.yOffset),c)},destroy:function(){this._super.apply(this,arguments),jQuery(document).off(".release",this.__keytracker)}});
//# sourceMappingURL=combined.min.map